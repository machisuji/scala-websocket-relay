<html>
<head>
    <title>WebSocket Relay Server</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <style type="text/css">
        .header {
            padding-left: 2em;
            text-transform: uppercase;
            background-color: #9966CC;
            color: #663377;
        }

        .header h1 {
            margin: 0
        }

        .client {
            background-color: #DDDDDD;
        }

        .intro {
            background-color: #CFAFFF;
        }

        .section {
            padding: 2em;
            padding-top: 0.5em;
            padding-bottom: 0.5em;
        }

        .column {
            display: inline-block;
            border-right: 2px groove #888888;
            margin-right: 1em;
            padding-right: 1em;
        }

        body {
            margin: 0
        }

        .code {
            font-family: monospace;
            background-color: #DDDDDD;
            padding: 2px;
        }

        .host-header {
          width: 33%;
        }

        .client-1-header {
          width: 33%;
        }

        .client-2-header {
          width: 33%;
        }
    </style>
</head>
<body>
<div class="header">
    <h1>WebSocket Relay Server</h1>
</div>
<div class="intro section">
    <p>
        Connects a host with clients through web sockets when the clients cannot connect to the host
        directly due to firewall restrictions. In this case the clients instead connect to this relay server.
    </p>
</div>
<div class="api section">
    <h2>API</h2>
    <ul>
        <li>
            <span class="code">GET /</span> - This page
        </li>
        <li>
            <span class="code">GET /session[?id=&lt;id&gt;&keepAlive=str] {Upgrade}</span> - WebSocket connection for the host.
            <span class="code">id</span> is an optional parameter useful when you want to reconnect to the same session.
            If ommitted a session ID will be generated.
            If <span class="code">keepAlive</span> is present <span class="code">"str"</span> is sent to the host every
            30s to make sure the connection is kept alive.
        </li>
        <li>
            <span class="code">GET /session/:id[?keepAlive=str][&dummyFallback=true] {Upgrade}</span> - WebSocket connection for clients.
            Any messages sent to this socket will be relayed to the host which connected through
            <span class="code">/session</span> to the session with the given ID.
            If <span class="code">keepAlive</span> is present <span class="code">"str"</span> is sent to the client every
            30s to make sure the connection is kept alive.
            If <span class="code">dummyFallback</span> is true then a client can connect to a session even
            if there is none. A dummy session will be opened which will just consume messages.
        </li>
    </ul>
</div>
<div class="protocol section">
    <h2>Protocol</h2>
    <p>
        There are the following message formats used for the host-to-server communication
        (<span class="code">/session</span>).
    </p>
    <ul>
        <li>
            <span class="code">session: &lt;session-id&gt;</span> - Sent as the first message from the relay
            (this) server to the connecting host to identify the created session. The host has to give this ID to
            any clients wanting to connect to it.
        </li>
        <li>
            <span class="code">connected: &lt;client-id&gt;</span> - Sent to the host when a client connects
            to the relay.
        </li>
        <li>
            <span class="code">disconnected: &lt;client-id&gt;</span> - Sent to the host when a client
            disconnects from the relay.
        </li>
        <li>
            <span class="code">&lt;client-id&gt;: &lt;message&gt;</span> - Message from the host to the client
            with the given ID or the other way around. Meaning this is the message a host has to send to relay
            a message to a client and at the same time this is the message a host will receive if a client
            wants to relay a message to it.
            Only the <span class="code">&lt;message&gt;</span> part will be sent to the client.
        </li>
        <li>
            <span class="code">unknown: &lt;client-id&gt;</span> - Response to the host when it tried
            sending a message to an unknown client.
        </li>
        <li>
            <span class="code">invalid</span> - Sent to the host when it sent a message that the relay
            did not understand.
        </li>
    </ul>
    <h3>Client Messages</h3>
    <p>
        Messages from clients are relayed as-is to the server listening to the given session.
    </p>
</div>
<div class="client section">
    <h2>Test</h2>

    <table>
      <tr>
        <th class="host-header">Host</th>
        <th class="client-1-header">Client 1</th>
        <th class="client-2-header">Client 2</th>
      </tr>
      <tr>
        <td>
          <input id="host-input" placeholder="Input"></input>
        </td>
        <td>
          <input id="client-1-input" placeholder="input"></input>
          <button id="client-1-connect">Connect</button>
        </td>
        <td>
          <input id="client-2-input" placeholder="input"></input>
          <button id="client-2-connect">Connect</button>
        </td>
      </tr>
      <tr>
        <td>
          <div id="host-output">&nbsp;</div>
        </td>
        <td>
          <div id="client-1-output">&nbsp;</div>
        </td>
        <td>
          <div id="client-2-output">&nbsp;</div>
        </td>
      </tr>
    </table>
</div>
</body>

<script type="text/javascript">
    $(document).ready(function() {
      var socket = new WebSocket("ws://$host:$port/session?keepAlive=keepAlive");

      socket.onmessage = function(e) {
        var response = e.data;

        if (response != "keepAlive") {
          $("#host-output").append(response + "</br>");
        }
        console.log("host received message: " + response);

        if (response.startsWith("session:")) {
          var sessionId = response.split(":")[1].trim();

          $("#client-1-connect").click(function() {
            var client = new WebSocket("ws://$host:$port/session/" + sessionId + "?keepAlive=keepAlive");

            client.onmessage = function(e) {
              var message = e.data;

              if (message != "keepAlive") {
                $("#client-1-output").append(message + "</br>");
              }
              console.log("client 1 received message: " + message);
            };

            client.onopen = function(e) {
              client.send("ClientId: 0x1000");
            };

            client.onclose = function(e) {
              $("#client-1-output").append("connection failed");
            };

            $("#client-1-input").change(function() {
              var message = $(this).val();

              client.send(message);
              console.log("client 1 sent message: " + message);

              $(this).val("");
            });
          });

          $("#client-2-connect").click(function() {
            var client2 = new WebSocket("ws://$host:$port/session/" + sessionId + "?keepAlive=keepAlive");

            client2.onmessage = function(e) {
              var message = e.data;

              if (message != "keepAlive") {
                $("#client-2-output").append(message + "</br>");
              }
              console.log("client 2 received message: " + message);
            };

            client2.onopen = function(e) {
              client2.send("ClientId: 0x1001");
            };

            client2.onclose = function(e) {
              $("#client-2-output").append("connection failed");
            };

            $("#client-2-input").change(function() {
              var message = $(this).val();

              client2.send(message);
              console.log("client 2 sent message: " + message);

              $(this).val("");
            });
          });
        }
      };

      socket.onclose = function(e) {
        $("#host-output").append("connection failed");
      };

      $("#host-input").change(function() {
        var message = $(this).val();

        socket.send(message);
        console.log("host sent message: " + message);
      });
    });
</script>
</html>
